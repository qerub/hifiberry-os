#!/bin/bash
set -e
cd `dirname $0`

if [ "$1" == "" ]; then
 VERSION=`cat .piversion`
 echo No version given, assuming Pi$VERSION
else
 VERSION=$1
fi

echo $VERSION > .piversion

BRDIR=`./brdir $VERSION`

echo "Building in $BRDIR"
echo $VERSION > $BRDIR/.piversion
echo $VERSION > buildroot/PIVERSION

SRC=configs/hifiberryos
#SRC=configs/hifiberryos-gui
TMP=./tmpfile.$$
DST=./config.$$
PLATFORM=configs/config$VERSION

if [ ! -f $PLATFORM ]; then
 echo Platform default configuration $PLATFORM not found. You need to create one using make xxxx_defconfig in buildroot
 exit 1
fi

cp $SRC $TMP

# These settings differ at at different Pi types
for i in BR2_ARCH_NEEDS_GCC_AT_LEAST_4_8 BR2_ARCH_NEEDS_GCC_AT_LEAST_4_9 BR2_ARCH_NEEDS_GCC_AT_LEAST_5 BR2_GCC_TARGET_CPU BR2_GCC_TARGET_FPU BR2_cortex_a53 BR2_cortex_a72 BR2_DEFCONFIG BR2_ROOTFS_POST_BUILD_SCRIPT BR2_ROOTFS_POST_IMAGE_SCRIPT BR2_LINUX_KERNEL_DEFCONFIG BR2_LINUX_KERNEL_INTREE_DTS_NAME BR2_PACKAGE_RPI_FIRMWARE_VARIANT_PI BR2_PACKAGE_RPI_FIRMWARE_VARIANT_PI4 BR2_ARM_CPU_HAS_NEON BR2_ARM_CPU_HAS_VFPV3 BR2_ARM_CPU_HAS_VFPV4 BR2_ARM_CPU_HAS_FP_ARMV8 BR2_ARM_CPU_HAS_THUMB BR2_ARM_CPU_ARMV6 BR2_arm1176jzf_s BR2_ARM_FPU_VFPV2 BR2_ARM_FPU_VFPV3 BR2_ARM_FPU_VFPV3D16 BR2_ARM_FPU_VFPV4 BR2_ARM_FPU_VFPV4D16 BR2_ARM_FPU_NEON BR2_ARM_FPU_FP_ARMV8 BR2_ARM_FPU_NEON_FP_ARMV8 BR2_SYSTEM_DHCP BR2_PACKAGE_BAYER2RGB_NEON BR2_PACKAGE_JPEG_SIMD_SUPPORT BR2_PACKAGE_NE10 BR2_PACKAGE_OPENBLAS BR2_PACKAGE_OPENBLAS_DEFAULT_TARGET BR2_PACKAGE_OPENBLAS_ARCH_SUPPORTS BR2_PACKAGE_RPI_FIRMWARE_VARIANT_PI BR2_PACKAGE_RPI_FIRMWARE_VARIANT_PI4 BR2_ARM_INSTRUCTIONS_THUMB2 BR2_ARM_ENABLE_VFP BR2_ARM_CPU_ARMV7A BR2_cortex_a7; do
  cat $TMP | grep  -v $i > $DST
  cat $PLATFORM | grep $i >> $DST
  mv $DST $TMP
done

# Always disable these
for i in BR2_PACKAGE_KVM_UNIT_TESTS BR2_PACKAGE_WF111 BR2_PACKAGE_XEN BR2_TARGET_TS4800_MBRBOOT BR2_PACKAGE_VALGRIND; do
 echo "$i=n" >> $TMP
done

if [ "$2" == "release" ]; then
 # for the releases, remove debug tools
 for i in BR2_PACKAGE_STRESS BR2_PACKAGE_STRESS_NG BR2_PACKAGE_STRACE BR2_PACKAGE_TCPDUMP; do
   echo "$i=n" >> $TMP
 done
fi

# Roon and Squeezelite are not supported on the Pi Zero
if [ "$VERSION" == "0w" ]; then
 for PKG in BR2_PACKAGE_RAAT BR2_PACKAGE_HIFIBERRY_SQUEEZELITE BR2_PACKAGE_LMSMPRIS BR2_PACKAGE_HIFIBERRY_MPD BR2_PACKAGE_MPD BR2_PACKAGE_MPD_MPRIS BR2_PACKAGE_HIFIBERRY_YMPD BR2_PACKAGE_SPOTIFY; do
   echo "$PKG=n" >> $TMP
 done
 echo BR2_PACKAGE_HIFIBERRY_TOOLS_AUDIO_LITE=y >> $TMP
fi

mv $TMP $DST
mv $DST $BRDIR/.config

# Update version
TS=`date +%Y%m%d`
echo $TS > buildroot/VERSION
